Version 4.1
SHEET 1 3156 720
WIRE -320 -896 -384 -896
WIRE -320 -880 -320 -896
WIRE -304 -880 -320 -880
WIRE -304 -848 -320 -848
WIRE -784 -832 -848 -832
WIRE -784 -816 -784 -832
WIRE -768 -816 -784 -816
WIRE 480 -816 432 -816
WIRE 608 -816 608 -848
WIRE 608 -816 560 -816
WIRE 784 -816 608 -816
WIRE -320 -800 -320 -848
WIRE -320 -800 -384 -800
WIRE -768 -784 -784 -784
WIRE 784 -784 784 -816
WIRE 608 -768 608 -816
WIRE 432 -752 432 -816
WIRE -784 -736 -784 -784
WIRE -784 -736 -848 -736
WIRE 1552 -704 1456 -704
WIRE 1712 -704 1632 -704
WIRE 608 -608 608 -688
WIRE 816 -608 608 -608
WIRE 608 -576 608 -608
WIRE 1552 -576 1456 -576
WIRE 1712 -576 1712 -704
WIRE 1712 -576 1632 -576
WIRE 1760 -576 1712 -576
WIRE 1792 -576 1792 -592
WIRE 1792 -576 1760 -576
WIRE 608 -560 608 -576
WIRE 112 -528 48 -528
WIRE 288 -528 192 -528
WIRE 304 -528 288 -528
WIRE 432 -528 432 -672
WIRE 432 -528 384 -528
WIRE -784 -480 -944 -480
WIRE -688 -480 -704 -480
WIRE -544 -480 -608 -480
WIRE -416 -480 -480 -480
WIRE -304 -480 -416 -480
WIRE 48 -480 48 -528
WIRE 48 -480 -304 -480
WIRE 432 -464 432 -528
WIRE 1360 -464 1264 -464
WIRE -688 -448 -688 -480
WIRE -608 -448 -608 -480
WIRE -304 -448 -304 -480
WIRE 288 -448 288 -528
WIRE 768 -448 704 -448
WIRE 800 -448 768 -448
WIRE -944 -432 -944 -480
WIRE 608 -432 608 -480
WIRE 704 -432 704 -448
WIRE 704 -432 608 -432
WIRE 1360 -432 1280 -432
WIRE -416 -416 -416 -480
WIRE 768 -416 768 -448
WIRE -544 -352 -544 -416
WIRE -944 -320 -944 -352
WIRE -752 -320 -944 -320
WIRE -688 -320 -688 -368
WIRE -688 -320 -752 -320
WIRE 288 -320 288 -384
WIRE 432 -320 432 -400
WIRE 432 -320 288 -320
WIRE 512 -320 432 -320
WIRE 608 -320 608 -352
WIRE 608 -320 512 -320
WIRE 768 -320 768 -352
WIRE 768 -320 608 -320
WIRE -608 -304 -608 -368
WIRE -480 -304 -480 -416
WIRE -480 -304 -608 -304
WIRE 1488 -288 1392 -288
WIRE 1600 -288 1568 -288
WIRE 1392 -160 1392 -288
WIRE 1472 -160 1392 -160
WIRE 1600 -160 1600 -288
WIRE 1600 -160 1536 -160
WIRE -336 -128 -336 -144
WIRE -320 -128 -336 -128
WIRE -224 -112 -256 -112
WIRE -320 -96 -336 -96
WIRE 1056 -80 992 -80
WIRE 1056 -64 1056 -80
WIRE 1072 -64 1056 -64
WIRE -336 -48 -336 -96
WIRE 1232 -48 1136 -48
WIRE 1392 -48 1392 -160
WIRE 1392 -48 1312 -48
WIRE 1424 -48 1392 -48
WIRE 1072 -32 1056 -32
WIRE 1600 -32 1600 -160
WIRE 1600 -32 1488 -32
WIRE 1424 -16 1392 -16
WIRE 976 16 912 16
WIRE 1056 16 1056 -32
WIRE 1392 48 1392 -16
WIRE 1504 80 1408 80
WIRE 1616 80 1584 80
WIRE 1408 208 1408 80
WIRE 1488 208 1408 208
WIRE 1616 208 1616 80
WIRE 1616 208 1552 208
WIRE 1040 288 976 288
WIRE 1040 304 1040 288
WIRE 1056 304 1040 304
WIRE 1216 320 1120 320
WIRE 1408 320 1408 208
WIRE 1408 320 1296 320
WIRE 1440 320 1408 320
WIRE 1056 336 1040 336
WIRE 1616 336 1616 208
WIRE 1616 336 1504 336
WIRE 1440 352 1408 352
WIRE 960 384 896 384
WIRE 1040 384 1040 336
WIRE 1408 416 1408 352
FLAG 512 -320 0
FLAG 800 -448 Vshunt
IOPIN 800 -448 Out
FLAG 368 384 0
FLAG 496 384 0
FLAG 368 304 Vcc+
FLAG 496 304 Vee-
FLAG 1104 -80 Vcc+
FLAG 1104 -16 Vee-
FLAG 1456 0 0
FLAG 1392 48 0
FLAG 1456 -64 Vcc+
FLAG 1600 -32 vctrl
IOPIN 1600 -32 Out
FLAG 896 384 Vshunt
IOPIN 896 384 In
FLAG 1088 288 Vcc+
FLAG 1088 352 Vee-
FLAG 816 288 0
FLAG 1472 368 0
FLAG 1408 416 0
FLAG 1472 304 Vcc+
FLAG 1616 336 Ictrl
IOPIN 1616 336 Out
FLAG -288 -144 Vcc+
FLAG -288 -80 Vee-
FLAG -336 -144 Tri
IOPIN -336 -144 In
FLAG -224 -112 PWM
IOPIN -224 -112 Out
FLAG 176 -576 0
FLAG 432 -528 Vm
IOPIN 432 -528 Out
FLAG 608 -576 Vc1
IOPIN 608 -576 Out
FLAG 608 -848 Vtot
IOPIN 608 -848 Out
FLAG -752 -320 0
FLAG -544 -352 0
FLAG -416 -352 0
FLAG -304 -368 0
FLAG 1792 -592 control
IOPIN 1792 -592 Out
FLAG 256 384 0
FLAG 256 304 Vcv
IOPIN 256 304 Out
FLAG 912 -80 Vcv
IOPIN 912 -80 In
FLAG 976 -608 0
FLAG 944 -784 0
FLAG 800 -832 soc2
IOPIN 800 -832 In
FLAG 832 -656 soc1
IOPIN 832 -656 In
FLAG 880 -656 0
FLAG 848 -832 0
FLAG 912 16 Vtot
IOPIN 912 16 In
FLAG 1280 -432 Vtot
IOPIN 1280 -432 In
FLAG 1392 -480 Vee-
FLAG 1392 -416 Vcc+
FLAG 1424 -448 -Vint
IOPIN 1424 -448 Out
FLAG -336 -48 control
IOPIN -336 -48 In
FLAG 1456 -704 vctrl
IOPIN 1456 -704 In
FLAG 1456 -576 Ictrl
IOPIN 1456 -576 In
FLAG 1568 -528 0
FLAG 1616 -752 0
FLAG 1760 -496 0
FLAG 1568 -752 Vtot
IOPIN 1568 -752 In
FLAG 1616 -528 -Vint
IOPIN 1616 -528 In
FLAG 128 -576 PWM
IOPIN 128 -576 Out
FLAG 1264 -544 0
FLAG 560 -496 soc1
FLAG 560 -704 soc2
FLAG -848 -736 onctrl
IOPIN -848 -736 In
FLAG -736 -832 Vcc+
FLAG -736 -768 Vee-
FLAG -928 -832 0
FLAG -704 -800 on
IOPIN -704 -800 Out
FLAG -560 -832 onctrl
IOPIN -560 -832 Out
FLAG -560 -752 0
FLAG 384 -736 0
FLAG 384 -688 on
IOPIN 384 -688 In
FLAG -432 192 0
FLAG -432 112 Tri
IOPIN -432 112 Out
FLAG -272 -896 Vcc+
FLAG -272 -832 Vee-
FLAG -240 -864 balance
IOPIN -240 -864 Out
FLAG -384 -896 soc2
FLAG -384 -800 soc1
SYMBOL ind 400 -544 R90
WINDOW 0 5 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName L1
SYMATTR Value 10m
SYMATTR SpiceLine Rser=1m
SYMBOL cap 416 -464 R0
SYMATTR InstName C1
SYMATTR Value 10m
SYMBOL res 592 -448 R0
SYMATTR InstName R1
SYMATTR Value 0.1
SYMBOL res 1008 -96 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R2
SYMATTR Value 10k
SYMBOL res 1072 0 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R3
SYMATTR Value 10k
SYMBOL voltage 368 288 R0
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR InstName V4
SYMATTR Value 15
SYMBOL voltage 496 288 R0
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR InstName V5
SYMATTR Value -15
SYMBOL res 1328 -64 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R4
SYMATTR Value 5k
SYMBOL cap 1536 -176 R90
WINDOW 0 0 32 VBottom 2
WINDOW 3 32 32 VTop 2
SYMATTR InstName C2
SYMATTR Value 1n
SYMBOL res 1584 -304 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R5
SYMATTR Value 5k
SYMBOL res 992 272 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R13
SYMATTR Value 10k
SYMBOL res 1056 368 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R14
SYMATTR Value 10k
SYMBOL voltage 912 288 R90
WINDOW 0 41 72 Left 2
WINDOW 3 -100 71 Left 2
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR InstName V2
SYMATTR Value 100m
SYMBOL res 1312 304 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R15
SYMATTR Value 5k
SYMBOL cap 1552 192 R90
WINDOW 0 0 32 VBottom 2
WINDOW 3 32 32 VTop 2
SYMATTR InstName C4
SYMATTR Value 10n
SYMBOL res 1600 64 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R16
SYMATTR Value 5k
SYMBOL diode 304 -384 R180
WINDOW 0 24 64 Left 2
WINDOW 3 24 0 Left 2
SYMATTR InstName D2
SYMBOL OpAmps\\UniversalOpAmp2 -288 -112 R0
SYMATTR InstName U10
SYMBOL cap 752 -416 R0
SYMATTR InstName C5
SYMATTR Value 10n
SYMBOL voltage -944 -448 R0
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR InstName V1
SYMATTR Value SINE(0 220 50)
SYMBOL res -688 -496 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R25
SYMATTR Value 1
SYMBOL ind -704 -464 R0
WINDOW 0 25 -15 Left 2
WINDOW 3 25 117 Left 2
SYMATTR InstName L2
SYMATTR Value 1
SYMATTR Type ind
SYMBOL ind -592 -352 R180
WINDOW 0 21 131 Left 2
WINDOW 3 -18 3 Left 2
SYMATTR InstName L3
SYMATTR Value 0.004
SYMATTR Type ind
SYMBOL diode -544 -464 R270
WINDOW 0 32 32 VTop 2
WINDOW 3 53 60 VBottom 2
SYMATTR InstName D1
SYMBOL diode -464 -416 R180
WINDOW 0 -31 23 Left 2
WINDOW 3 -15 5 Left 2
SYMATTR InstName D3
SYMBOL diode -528 -416 R180
WINDOW 0 24 64 Left 2
WINDOW 3 34 43 Left 2
SYMATTR InstName D4
SYMBOL diode -544 -400 R270
WINDOW 0 -33 58 VTop 2
WINDOW 3 0 32 VBottom 2
SYMATTR InstName D5
SYMBOL cap -432 -416 R0
SYMATTR InstName C6
SYMATTR Value 2200µ
SYMBOL res -320 -464 R0
SYMATTR InstName R26
SYMATTR Value 100
SYMBOL voltage 256 288 R0
WINDOW 0 41 72 Left 2
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR InstName V10
SYMATTR Value 8.25
SYMBOL res 992 -624 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName 1k
SYMATTR Value 1K
SYMBOL sw 912 -608 R90
SYMATTR InstName S3
SYMATTR Value SW2
SYMBOL res 960 -800 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R18
SYMATTR Value 1K
SYMBOL sw 880 -784 R90
SYMATTR InstName S4
SYMATTR Value SW2
SYMBOL OpAmps\\LT1022A 1104 -112 R0
SYMATTR InstName U11
SYMBOL OpAmps\\LT1022A 1088 256 R0
SYMATTR InstName U12
SYMBOL OpAmps\\LT1014 1472 272 R0
SYMATTR InstName U1
SYMBOL OpAmps\\LT1014 1456 -96 R0
SYMATTR InstName U7
SYMBOL OpAmps\\LT1022A 1392 -384 M180
SYMATTR InstName U2
SYMBOL sw 1536 -576 R270
WINDOW 3 8 132 Left 2
SYMATTR InstName S5
SYMATTR Value SW2
SYMBOL res 1744 -592 R0
SYMATTR InstName R17
SYMATTR Value 1Meg
SYMBOL voltage 1264 -448 R180
WINDOW 0 24 96 Left 2
WINDOW 3 24 16 Left 2
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR InstName V7
SYMATTR Value 8.25
SYMBOL res 576 -832 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R19
SYMATTR Value 0.1
SYMBOL sw 1648 -704 R90
SYMATTR InstName S6
SYMBOL sw 208 -528 R90
SYMATTR InstName S1
SYMBOL Li-Ion 480 -720 R0
WINDOW 39 191 -3 VCenter 1
SYMATTR InstName X1
SYMATTR SpiceLine Isoc=0.016 Capacity.Ah=1.9
SYMBOL Li-Ion 480 -512 R0
WINDOW 39 191 -3 VCenter 1
SYMATTR InstName X2
SYMATTR SpiceLine Isoc=0.020 Capacity.Ah=1.9
SYMBOL voltage -832 -832 R90
WINDOW 0 41 72 Left 2
WINDOW 3 -25 146 Left 2
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR InstName V3
SYMATTR Value 10m
SYMBOL OpAmps\\UniversalOpAmp2 -736 -800 R0
SYMATTR InstName U3
SYMBOL bv -560 -848 R0
SYMATTR InstName B1
SYMATTR Value V=(V(Vshunt)+2-V(soc2)-V(soc1)+ABS(V(balance)))
SYMBOL sw 432 -768 R0
SYMATTR InstName S2
SYMBOL voltage -432 96 R0
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR InstName V6
SYMATTR Value PULSE(0 5 0 4e-3 4e-3 0.01p 8e-3)
SYMBOL OpAmps\\UniversalOpAmp2 -272 -864 R0
SYMATTR InstName U4
TEXT 112 96 Left 2 !.tran 20k
TEXT 48 16 Left 2 !.model SW SW(Ron=1, Roff=100Meg, Vt=8.25, Vh=0.1)
TEXT 72 -24 Left 2 !.options gmin=1e-12 abstol=1n reltol=0.1
TEXT 624 -472 Left 2 ;3V inicial
TEXT 688 -672 Left 2 ;2.7V inicial
TEXT 104 -192 Left 2 !.ic I(L1)=0
TEXT 64 56 Left 2 !.model SW2 SW(Ron=1, Roff=100Meg, Vt=0.95V, Vh=0.05)
TEXT -744 -264 Left 2 !K1 L2 L3 1
TEXT -784 -592 Left 2 ;Conversor de 220V AC - 12V DC
TEXT -360 128 Left 2 ;Onda triangular de 0-3V
TEXT 1128 144 Left 2 ;Controlador CC
TEXT 1128 -192 Left 2 ;Controlador CV
TEXT 248 -600 Left 2 ;Buck
TEXT 856 -712 Left 2 ;Proteccion de sobrecarga
TEXT 824 -408 Left 2 ;Punto de medida de I
TEXT -384 -240 Left 2 ;Comparador para PWM
TEXT 1448 -856 Left 2 ;Selector de Modo CC/CV
TEXT 96 -240 Left 2 !.ic V(on)=15
TEXT 112 -72 Left 2 !.options cshunt = 1e-9
TEXT 304 -240 Left 2 !.ic V(Vot)=5.7
TEXT 304 -184 Left 2 !.ic V(Vc1)=3
TEXT -792 -944 Left 2 ;Apagado automatico
TEXT -24 480 Left 2 !.measure tran iR1_avg AVG I(R1) FROM 0s TO 5.6Ks
TEXT -32 528 Left 2 !.meas TRAN Vtot_avg AVG V(Vtot) FROM 5.6Ks TO 12Ks
TEXT -32 560 Left 2 !.meas TRAN Vc2_avg AVG V(Vtot)-V(vc1) FROM 5.6Ks TO 12Ks
TEXT -16 600 Left 2 !.meas TRAN Vc1_avg AVG V(vc1) FROM 5.6Ks TO 12Ks
